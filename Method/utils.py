import os, re, json, random, time, math
import pandas as pd

## Function: used by load_chem_annotation() and load_chem_annotation_with_feedback(); used to recover background_survey_strict and background_question_strict
# background_strict_raw: a list of the raw background survey, some of them are "NA"; when it is "NA", we should find its component in background_normal
# background_normal: a list of the normal background survey, no "NA"
# background_strict_raw_nan_indicator: a list of boolean values indicating whether the corresponding background_strict_raw is "NA"
def recover_raw_background(background_strict_raw, background_normal, background_strict_raw_nan_indicator):
    background_strict = []
    for cur_survey_id, cur_survey in enumerate(background_strict_raw):
        if background_strict_raw_nan_indicator[cur_survey_id]:
            cur_value = background_normal[cur_survey_id].strip()
            background_strict.append(cur_value)
        else:
            cur_survey = cur_survey.strip()
            # this assertion is to make sure the content is not variants of "NA"
            assert len(cur_survey) > 10
            cur_value = cur_survey
            background_strict.append(cur_value)
    return background_strict


# load xlsx annotations, bkg question -> inspirations
# bkg_q: [bq0, bq1, ...]
# dict_bkg2insp: {'bq0': [insp0, insp1, ...], 'bq1': [insp0, insp1, ...], ...}
# dict_bkg2survey: {'bq0': survey0, 'bq1': survey1, ...}
def load_chem_annotation(chem_annotation_path, if_use_strict_survey_question=1, if_use_background_survey=1):
    assert if_use_strict_survey_question in [0, 1]
    assert if_use_background_survey in [0, 1]
    if if_use_background_survey == 0:
        print("Warning: Not Using Survey.")
    ## load chem_research.xlsx to know the groundtruth inspirations
    chem_annotation = pd.read_excel(chem_annotation_path, 'Overall')
    nan_values = chem_annotation.isna()
    bkg_survey = list(chem_annotation[chem_annotation.columns[4]])
    # some of the components are "NA"; if it is NA, we should find its component in bkg_survey
    bkg_survey_strict_raw = list(chem_annotation[chem_annotation.columns[5]])
    # print("bkg_survey_strict_raw: ", bkg_survey_strict_raw)
    bkg_survey_strict = recover_raw_background(bkg_survey_strict_raw, bkg_survey, nan_values[chem_annotation.columns[5]])
    bkg_q = list(chem_annotation[chem_annotation.columns[6]])
    # some of the components are "NA"; if it is NA, we should find its component in bkg_q
    bkg_q_strict_raw = list(chem_annotation[chem_annotation.columns[7]])
    bkg_q_strict = recover_raw_background(bkg_q_strict_raw, bkg_q, nan_values[chem_annotation.columns[7]])
    insp1 = list(chem_annotation[chem_annotation.columns[9]])
    insp2 = list(chem_annotation[chem_annotation.columns[11]])
    insp3 = list(chem_annotation[chem_annotation.columns[13]])
    groundtruthHyp = list(chem_annotation[chem_annotation.columns[15]])
    reasoningprocess = list(chem_annotation[chem_annotation.columns[17]])
    note = list(chem_annotation[chem_annotation.columns[18]])
    finegrained_hyp = list(chem_annotation[chem_annotation.columns[19]])
    finegrained_exp = list(chem_annotation[chem_annotation.columns[20]])
    ## determine which version of survey and question to use
    if if_use_strict_survey_question:
        bkg_survey = bkg_survey_strict
        bkg_q = bkg_q_strict
    ## start looping for collection
    dict_bkg2insp, dict_bkg2survey, dict_bkg2groundtruthHyp, dict_bkg2note, dict_bkg2reasoningprocess = {}, {}, {}, {}, {}
    dict_bkg2idx, dict_idx2bkg = {}, {}
    dict_bkg2fg_hyp, dict_bkg2fg_exp = {}, {}
    for cur_b_id, cur_b in enumerate(bkg_q):
        # update bkg_q to remove leading and trailing spaces
        cur_b = cur_b.strip()
        bkg_q[cur_b_id] = cur_b
        ## dict_bkg2insp
        cur_b_insp = []
        # insp1
        if nan_values[chem_annotation.columns[9]][cur_b_id] == False:
            cur_b_insp.append(insp1[cur_b_id].strip())
        # insp2
        if nan_values[chem_annotation.columns[11]][cur_b_id] == False:
            cur_b_insp.append(insp2[cur_b_id].strip())
        # insp3
        if nan_values[chem_annotation.columns[13]][cur_b_id] == False:
            cur_b_insp.append(insp3[cur_b_id].strip())
        dict_bkg2insp[cur_b] = cur_b_insp
        ## dict_bkg2survey
        if if_use_background_survey:
            assert nan_values[chem_annotation.columns[4]][cur_b_id] == False
            dict_bkg2survey[cur_b] = bkg_survey[cur_b_id].strip()
        else:
            dict_bkg2survey[cur_b] = "Survey not provided. Please overlook the survey."
        ## dict_bkg2groundtruthHyp
        assert nan_values[chem_annotation.columns[15]][cur_b_id] == False
        dict_bkg2groundtruthHyp[cur_b] = groundtruthHyp[cur_b_id].strip()
        ## dict_bkg2reasoningprocess
        assert nan_values[chem_annotation.columns[17]][cur_b_id] == False
        dict_bkg2reasoningprocess[cur_b] = reasoningprocess[cur_b_id].strip()
        ## dict_bkg2note
        assert nan_values[chem_annotation.columns[18]][cur_b_id] == False
        dict_bkg2note[cur_b] = note[cur_b_id].strip()
        ## dict_bkg2idx, dict_idx2bkg
        dict_bkg2idx[cur_b] = cur_b_id
        dict_idx2bkg[cur_b_id] = cur_b
        ## dict_bkg2fg_hyp, dict_bkg2fg_exp
        dict_bkg2fg_hyp[cur_b] = finegrained_hyp[cur_b_id]
        dict_bkg2fg_exp[cur_b] = finegrained_exp[cur_b_id]
    # return bkg_q, dict_bkg2insp, dict_bkg2survey, dict_bkg2groundtruthHyp, dict_bkg2note, dict_bkg2idx, dict_idx2bkg, dict_bkg2reasoningprocess
    return bkg_q, dict_bkg2survey, dict_bkg2groundtruthHyp, dict_bkg2fg_hyp, dict_bkg2fg_exp, dict_bkg2note



# Call Openai API,k input is prompt, output is response
# api_type: 0 for OpenAI, 1 for Azure OpenAI
def llm_generation(prompt, model_name, client, temperature=1.0, api_type=0):
    if_api_completed = False
    model = model_name
    # start inference util we get generation
    while if_api_completed == False:
        try:
            completion = client.chat.completions.create(
            model=model,
            temperature=temperature,
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": prompt}
                ]
            )
            generation = completion.choices[0].message.content.strip()
            if_api_completed = True
        except Exception as e:
            print("OpenAI reaches its rate limit: ", e)
            time.sleep(0.25)
    return generation



# gene: (generated) text; '#' and '*' will be removed from gene, since they are assumed to be generated by LLM as markdown format --- this format can result in not exact match between the title extracted from generation and the groundtruth title in the benchmark
# template: ['Title:', 'Reason:']
# structured_gene: [[Title, Reason], ...]
def get_structured_generation_from_raw_generation(gene, template):
    # use .strip("#") to remove the '#' or "*" in the gene (the '#' or "*" is usually added by the LLM as a markdown format); used to match text (eg, title)
    gene = re.sub("[#*]", "", gene).strip()
    assert len(template) == 2, print("template: ", template)
    # # some times generation will capitalize the first letter of the template, so we use the lower case for both generation and template to match: not adopting it since it might influence chemistry terms (e.g., Fe2+ -> fe2+)
    # gene = gene.lower()
    # template = [item.lower() for item in template]
    # the template might not appear in the first sentence of the gene, get rid of noise sentences before the first template[0]
    if not gene.startswith(template[0]):
        gene_split = gene.split('\n')
        # if the gene is not starting with the title, the second paragraph in gene_split might be the title
        gene_split = [item for item in gene_split if item.strip() != ""]
        assert len(gene_split) >= 2, print("gene_split: ", gene_split)
        # iterate to find the first template[0] in gene_split
        for id_line, line in enumerate(gene_split):
            if gene_split[id_line].find(template[0]) > 0 and gene_split[id_line].find(template[0]) < 15:
                gene_split_split = gene_split[id_line].split(template[0])
                assert len(gene_split_split) == 2, print("gene_split_split: ", gene_split_split)
                gene_split[id_line] = template[0] + gene_split_split[1]
            if gene_split[id_line].startswith(template[0]):
                gene = '\n'.join(gene_split[id_line:])
                break
        # assert gene.startswith(template[0]), print("gene: ", gene)
        assert gene.startswith(template[0])
    # structured_gene: [[title, reason], [title, reason], ...]
    structured_gene = []
    gene_split = gene.split(template[0])
    # split to every title block, including one title and one reason
    for cur_gs in gene_split:
        # split the one title and one reason
        cur_gs = cur_gs.strip()
        if cur_gs == "":
            continue
        cur_gs_split = cur_gs.split(template[1])
        # deal with unexpected situations
        if len(cur_gs_split) > 2:
            # if there are more than one template[1] in cur_gs, we prefer the one with prefix as '\n' (since it matches more as the designed format)
            cur_gs_split = cur_gs.split('\n' + template[1])
            # by preferring the one with prefix as '\n' still do not work, so we simply concatenate the rest of the elements other than the first element
            if len(cur_gs_split) > 2:
                cur_gs_split = [cur_gs_split[0], '\n'.join(cur_gs_split[1:])]
            # in case none of the template[1] is with prefix as '\n'
            elif len(cur_gs_split) == 1:
                cur_gs_split = cur_gs.split(template[1])
                cur_gs_split = [cur_gs_split[0], '\n'.join(cur_gs_split[1:])]
        # assert len(cur_gs_split) == 2, print("cur_gs_split: ", cur_gs_split)
        assert len(cur_gs_split) == 2
        # strip every elements in cur_gs_split
        for i in range(len(cur_gs_split)):
            cur_gs_split[i] = cur_gs_split[i].strip().strip(";").strip()
        structured_gene.append(cur_gs_split)
    return structured_gene





def get_structured_generation_from_raw_generation_by_llm(gene, template, client, temperature, api_type, model_name="gpt-4o-mini"):
    assert isinstance(gene, str), print("type(gene): ", type(gene))
    # use .strip("#") to remove the '#' or "*" in the gene (the '#' or "*" is usually added by the LLM as a markdown format); used to match text (eg, title)
    gene = re.sub("[#*]", "", gene).strip()
    assert len(template) == 2, print("template: ", template)
    # In your answer, please only mention the words in the template when use it as a template. For example, if the template is ['Hypothesis:', 'Reasoning Process:'], then your answer should not contain 'Analysis of the Hypothesis:', since it also contain 'Hypothesis:'.
    # Whenever there are information in the passage related to the template, please restructure the information into the template format;
    prompt = "You are a helpful assistant.\nPlease help to organize the following passage into a structured format, following the template. When restructure the passage with the template, please try not to rephrase but to use the original information in the passage (to avoid information distortion). If the template is only about a subset of information in the passage, you can extract only that subset of information to fill the template. If there is no such information for the template in the passage, please still output the exact template first, and fill the content for the template as 'None'. \n\nThe passage is: \n" + gene + f"\n\nThe template is: \n{template[0]} \n{template[1]} \n. Now, please restructure the passage strictly with the template (literally strictly, e.g., the case style of the template should also remain the same when used to restructure the passage)."
    # print("prompt: ", prompt)
    
    # while loop to make sure there will be one successful generation
    while True:
        try:
            generation = llm_generation(prompt, model_name, client, temperature=temperature, api_type=api_type)
            # print("generation (in): ", generation)
            structured_gene = get_structured_generation_from_raw_generation(generation, template=template)
            # print("structured_gene (in): ", structured_gene)
            break
        except Exception as e:
            if temperature < 1.5:
                temperature += 0.25
            if temperature >= 0.7:
                model_name = "gpt-4o"
            # if the format of feedback is wrong, try again in the while loop
            print("generation (in): ", generation)
            print("template: ", template)
            print("Exception (in): {}, try again..".format(repr(e)))
            print(f"update temperature to {temperature} and use {model_name} for extraction in case new generation can be successful..")
    # print("structured_gene: ", structured_gene)
    return structured_gene


    



## Function:
#   llm inference with the prompt + guarantee to reply a structured generation accroding to the template (guarantee by the while loop)
#   gene_format_constraint: [id of structured gene to comply with the constraint, constraint (['Yes', 'No'], where the content in the id of structured gene should be inside the constraint)]
#   if_only_return_one_structured_gene_component: True or False; most of the time structured_gene will only have one component (eg, [[hyp, reasoning process]]). When it is True, this function will only return the first element of structured_gene. If it is set to true and structured_gene has more than one component, a warning will be raised
def llm_generation_while_loop(prompt, model_name, client, if_structured_generation=False, template=None, gene_format_constraint=None, if_only_return_one_structured_gene_component=False, temperature=1.0, api_type=0, restructure_output_model_name="gpt-4o-mini"):
    # assertions
    assert if_structured_generation in [True, False]
    if if_structured_generation:
        assert template is not None

    # while loop to make sure there will be one successful generation
    while True:
        try:
            generation = llm_generation(prompt, model_name, client, temperature=temperature, api_type=api_type)
            # structured_gene
            if if_structured_generation:
                # structured_gene: [[title, reason], [title, reason], ...]
                # try with template matching first, if not work, try llm to formulate the generation according to the template; if not work again, then probably it is the problem of the original generation, then try llm_generation() again
                try:
                    # print("Using a template matching method to extract information from the LLM's generation")
                    structured_gene = get_structured_generation_from_raw_generation(generation, template=template)
                except:
                    # print("Information to be extracted by an LLM from the LLM's generation")
                    structured_gene = get_structured_generation_from_raw_generation_by_llm(generation, template=template, client=client, temperature=temperature, api_type=api_type, model_name=restructure_output_model_name)
                if gene_format_constraint != None:
                    assert len(gene_format_constraint) == 2, print("gene_format_constraint: ", gene_format_constraint)
                    # we use structured_gene[0] here since most of the time structured_gene will only have one component (eg, [[hyp, reasoning process]])
                    assert structured_gene[0][gene_format_constraint[0]].strip() in gene_format_constraint[1], print("structured_gene[0][gene_format_constraint[0]].strip(): {}; gene_format_constraint[1]: {}".format(structured_gene[0][gene_format_constraint[0]].strip(), gene_format_constraint[1]))
            break
        except Exception as e:
            # if the format of feedback is wrong, try again in the while loop
            # print("generation: ", generation)
            print("AssertionError: {}, try again..".format(repr(e)))
            

    # structured_gene
    if if_structured_generation:
        if if_only_return_one_structured_gene_component:
            if len(structured_gene) > 1:
                print("Warning: structured_gene has more than one component: ", structured_gene)
            return structured_gene[0]
        else:
            return structured_gene
    else:
        return generation
    

# Input:
#   input_list: [[item0, item1, ...], [item0, item1, ...], ...]
# Output:
#   output_list: [[item1, item0, ...], [item1, item0, ...], ...]
def exchange_order_in_list(input_list):
    output_list = []
    for cur_input_list in input_list:
        assert len(cur_input_list) == 2
        output_list.append(cur_input_list[::-1])
    return output_list



# hypothesis examples to show to the framework, as the goals
hyp_example_hierarchy_1 = "The reaction mechanism of the engineered enzyme SNAr1.3 in nucleophilic aromatic substitution (SNAr) involves the nucleophilic attack on the electron-deficient aromatic ring, facilitated by the enzyme’s active site. The enzyme stabilizes the transition state through a halide-binding pocket formed by key residues like Arg124 and Asp125, which help position and activate the electrophilic substrate. Arg124 plays a crucial role by acting as a hydrogen-bond donor, assisting in the activation and proper positioning of the nucleophile for efficient attack. The process proceeds via a non-covalent pathway, with no evidence of covalent enzyme-substrate intermediates, ensuring high selectivity and catalytic efficiency."
hyp_example_hierarchy_2 = "This hypothesis describes the engineered enzyme SNAr1.3, which catalyzes nucleophilic aromatic substitution (SNAr) reactions. The general components required for this reaction include an electron-deficient aromatic electrophile and a nucleophile capable of attacking the electrophilic carbon. The enzyme’s halide-binding pocket plays a critical role in stabilizing the transition state by holding the halide in place and facilitating its departure as the leaving group. The nucleophile is activated by the enzyme, which positions it for a precise nucleophilic attack on the aromatic ring. The hydrogen-bonding interaction between the enzyme and nucleophile ensures that the nucleophile is correctly oriented and activated, which is essential for achieving selectivity and stereocontrol in the reaction. The mechanism proceeds through a non-covalent pathway, without forming covalent enzyme-substrate intermediates, allowing the enzyme to efficiently catalyze the reaction with high selectivity and catalytic efficiency. These general components are essential for ensuring the enzyme’s ability to selectively catalyze the nucleophilic substitution reaction."
hyp_example_hierarchy_3 = "The engineered enzyme SNAr1.3 catalyzes nucleophilic aromatic substitution (SNAr) reactions, where the nucleophile attacks the electron-deficient aromatic electrophile, displacing the halide as the leaving group. The electrophile must be electron-deficient, often through the presence of electron-withdrawing groups like nitro or trifluoromethyl, which make the carbon attached to the halide more reactive. Specific examples of such electrophilic substrates include 2,4-dinitrochlorobenzene. The nucleophile, typically a carbon-based nucleophile such as ethyl 2-cyanopropionate, provides the electron pair required to displace the halide. This nucleophile is often in an enolate form, which the enzyme activates to enhance its nucleophilicity.\nThe enzyme’s halide-binding pocket, formed by Arg124 and Asp125, stabilizes the transition state and facilitates the departure of the halide leaving group. This pocket ensures that the halide is properly aligned for efficient departure, lowering the activation energy for the substitution. Arg124 acts as a hydrogen-bond donor, interacting with the nucleophile and ensuring its activation and proper positioning for nucleophilic attack on the electrophilic carbon. This hydrogen-bonding is crucial for achieving the selectivity and stereocontrol of the reaction. The reaction proceeds via a non-covalent mechanism, avoiding covalent enzyme-substrate intermediates, which distinguishes it from traditional SN1 or SN2 pathways. The enzyme's active site, with its precise arrangement of residues, ensures high selectivity, efficiency, and stereocontrol, enabling it to catalyze reactions with a broad range of electrophiles and nucleophiles."
hyp_example_hierarchy_4 = "The engineered enzyme SNAr1.3 catalyzes nucleophilic aromatic substitution (SNAr) reactions, where a nucleophile attacks an electron-deficient aromatic electrophile, leading to the displacement of the halide as the leaving group. Below is a detailed, integrated hypothesis, including the specific components and their roles in the reaction mechanism:\n1.Electron-Deficient Aromatic Electrophile (General Component: Electron-Deficient Aromatic Electrophiles): The electron-deficient aromatic electrophile is crucial for making the carbon bonded to the halide more electrophilic and reactive to nucleophilic attack. A typical example is 2,4-dinitrochlorobenzene (specific component), which contains nitro groups that withdraw electron density from the aromatic ring, thereby enhancing the carbon’s electrophilicity. The IUPAC name of this compound is 2-chloro-1,3-dinitrobenzene, and its SMILES string is ClC1=CC(=C(C=C1N+[O-])N+)(N+[O-]). The electron-deficient nature of this electrophile makes it highly reactive toward nucleophiles, facilitating the substitution of the halide leaving group.\n2.Nucleophile (General Component: Nucleophiles): The nucleophile is critical for providing the electron pair necessary to attack the electrophilic carbon of the aromatic ring. Ethyl 2-cyanopropionate (specific component) serves as an ideal nucleophile, providing an enolate form that is activated by the enzyme to enhance nucleophilicity. The IUPAC name of this nucleophile is ethyl 2-cyano-3-phenylpropionate, and its SMILES string is CC(C(=O)OCC)C#N. The nucleophile attacks the electrophilic carbon of the aromatic ring, displacing the halide group. The enolate form is especially reactive because of its negative charge, which is stabilized by the enzyme, enhancing the reaction rate and ensuring a clean substitution.\n3.Halide-Binding Pocket (General Component: Halide-Binding Sites): The halide-binding pocket, formed by residues like Arg124 and Asp125 (specific components), stabilizes the halide as it departs during the reaction. This pocket ensures that the halide is correctly aligned for efficient leaving group activation. The hydrophobic nature of the pocket minimizes the steric clash between the halide and the rest of the active site while stabilizing the transition state. This stabilization lowers the activation energy of the reaction, facilitating the nucleophilic attack. The presence of this pocket ensures that the leaving group is positioned in a way that maximizes the efficiency of the substitution reaction.\n4.Hydrogen-Bonding Interaction (General Component: Hydrogen-Bond Donors): The interaction between the hydrogen-bond donor residue Arg124 (specific component) and the nucleophile (e.g., ethyl 2-cyanopropionate) is vital for activating the nucleophile and positioning it for attack on the electrophilic carbon. Arg124 donates a hydrogen bond to the enolate, which stabilizes the nucleophile and enhances its reactivity. This interaction ensures that the nucleophile is oriented correctly, contributing to the selectivity and stereoselectivity of the reaction. The hydrogen-bonding also plays a role in controlling the stereochemical outcome of the nucleophilic attack, ensuring that the desired stereoisomer is produced.\n5.Non-Covalent Mechanism (General Component: Non-Covalent Catalysis): The enzyme catalyzes the reaction via a non-covalent mechanism, meaning that no covalent enzyme-substrate intermediates are formed. Instead, the enzyme uses non-covalent interactions (like hydrogen bonding and halide binding) to stabilize the transition state and activate the nucleophile, facilitating the substitution reaction. This non-covalent pathway distinguishes the enzyme-catalyzed mechanism from traditional SN1 or SN2 mechanisms, which may involve covalent intermediates. By avoiding covalent intermediates, the enzyme ensures high selectivity, efficiency, and stereocontrol, enabling the reaction to proceed smoothly and efficiently."
hyp_example_hierarchy_5 = "The engineered enzyme SNAr1.3 catalyzes nucleophilic aromatic substitution (SNAr) reactions, where the nucleophile attacks an electron-deficient aromatic electrophile, leading to the displacement of the halide as the leaving group.\n1.Electron-Deficient Aromatic Electrophile (General Component: Electron-Deficient Aromatic Electrophiles):\nThe electron-deficient aromatic electrophile is essential for making the carbon attached to the halide more electrophilic and reactive to nucleophilic attack. A typical example is 2,4-dinitrochlorobenzene (specific component), which contains nitro groups that withdraw electron density from the aromatic ring, making the electrophilic carbon more reactive. The IUPAC name is 2-chloro-1,3-dinitrobenzene, and the SMILES string is ClC1=CC(=C(C=C1N+[O-])N+)(N+[O-]). This electron-withdrawing effect increases the electrophilicity of the carbon attached to the halide, facilitating its displacement by the nucleophile.\n2.Nucleophile (General Component: Nucleophiles):\nThe nucleophile is critical for providing the electron pair necessary to attack the electrophilic carbon on the aromatic ring. Ethyl 2-cyanopropionate (specific component) serves as the nucleophile, which provides an enolate that is activated by the enzyme to enhance its nucleophilicity. The IUPAC name for this nucleophile is ethyl 2-cyano-3-phenylpropionate, and its SMILES string is CC(C(=O)OCC)C#N. The enolate form of this nucleophile is highly reactive, allowing it to attack the electrophilic carbon and form a new C–C bond, displacing the halide leaving group.\n3.Halide-Binding Pocket (General Component: Halide-Binding Sites):\nThe enzyme features a halide-binding pocket, formed by residues like Arg124 and Asp125 (specific components), which stabilize the transition state and facilitate the departure of the halide leaving group. The pocket holds the halide in place, ensuring it is aligned properly for efficient departure. This stabilization lowers the activation energy of the reaction, ensuring the nucleophile can attack the electrophilic carbon efficiently.\n4.Hydrogen-Bonding Interaction (General Component: Hydrogen-Bond Donors):\nThe hydrogen-bond donor Arg124 (specific component) interacts with the nucleophile (e.g., ethyl 2-cyanopropionate) to activate it and position it for the nucleophilic attack on the electrophilic carbon. The hydrogen-bonding interaction stabilizes the nucleophile, ensuring proper alignment and enhancing its reactivity. This interaction contributes to the selectivity and stereoselectivity of the reaction, ensuring that the desired product is formed with high efficiency.\n5.Non-Covalent Mechanism (General Component: Non-Covalent Catalysis):\nThe enzyme catalyzes the reaction via a non-covalent mechanism, meaning there are no covalent enzyme-substrate intermediates. Instead, the enzyme uses non-covalent interactions (such as hydrogen bonding and halide binding) to stabilize the transition state and activate the nucleophile, facilitating the substitution reaction. This non-covalent mechanism distinguishes the enzyme’s catalysis from traditional SN1 and SN2 mechanisms, which often involve covalent intermediates. The use of non-covalent interactions contributes to high selectivity, efficiency, and stereocontrol in the reaction.\nExperimental Conditions:\n1.Reaction Temperature:\nThe reaction is carried out at room temperature (approximately 25°C) to maintain optimal enzyme activity. This temperature ensures that the enzyme is sufficiently active to catalyze the reaction without denaturation. Higher temperatures may be used to increase reaction rate but must be controlled to avoid compromising enzyme stability.\n2.Solvent System:\nThe reaction is performed in a polar organic solvent, such as dichloromethane (DCM) or ethanol, which effectively dissolves both the nucleophile and electron-deficient aromatic electrophile (e.g., 2,4-dinitrochlorobenzene). These solvents provide a stable medium that supports efficient interaction between the reactants and the enzyme.\n3.Concentration of Reactants:\nThe electrophile (e.g., 2,4-dinitrochlorobenzene) is typically used at a concentration of 10–20 mM, while the nucleophile (e.g., ethyl 2-cyanopropionate) is used in excess (2–3 times the molar concentration of the electrophile). The enzyme concentration is optimized to be 1–5 µM, ensuring efficient catalysis while minimizing substrate inhibition.\n4.	Reaction Time:\nThe reaction is typically allowed to proceed for 1–4 hours, depending on the desired yield and reaction rate. The reaction’s progress can be monitored via HPLC or GC, tracking the formation of the product and ensuring the reaction is proceeding as expected.\n5.Atmosphere:\nThe reaction is generally conducted under ambient air unless the enzyme is sensitive to oxygen or requires an inert atmosphere. For enzymes sensitive to oxidation, a nitrogen or argon atmosphere can be used to protect the enzyme from oxidative degradation.\n6.Work-Up Procedure:\nAfter the reaction, the mixture is quenched by adding water or a weak acid to neutralize the enzyme. The product is then extracted using an organic solvent like ethyl acetate, and the solvent is removed under reduced pressure. The product is purified using column chromatography or recrystallization, depending on its solubility and purity requirements.\n7.Purification and Yield:\nThe final product is purified using flash chromatography or thin-layer chromatography (TLC). The yield can reach up to 90% for well-optimized conditions, ensuring high turnover numbers and minimal by-products.\n"



# A collection of prompts for different modules
def instruction_prompts(module_name, assist_info=None):
    num_major_details_tradition = "eight"
    if module_name == "greedy_search_first_step":
        assert assist_info == None or assist_info == [0]
        assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis we want to reach should look like this example: \n" + hyp_example_hierarchy_5 + "\nIn this example, there are five major components, and sufficient details and experimental conditions for each major component."
        # Taking an organic chemistry example, the final fine-grained hypothesis we want to reach might include these details: '[Reaction type: Metal catalysis, enzymatic catalysis, photocatalysis, or electrocatalysis], [Reaction system: Which metal is used, such as iron, copper, rhodium, etc.], [Ligand type and details: Is it a phosphine ligand, nitrogen ligand, etc., and what functional groups are included], [Specific chemicals to use beyong the specification of reaction system and ligand type], [Reaction temperature], [Solvent type], [Reaction mechanism details], [Concentration of each chemical]'. This is not a complete list of all possible aspects of the details, but every piece of information in this example can be seen as a detail. In this example, '[Reaction mechanism details]' belongs to reaction mechanism; [Reaction type], [Reaction system], and [Ligand type] belong to major components; [Ligand type details], [Specific chemicals to use beyong the specification of reaction system and ligand type], [Reaction temperature], [Solvent type], and [Concentration of each chemical] belong to details to the major components. \
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, and a preliminary coarse-grained research hypothesis for the research question, please help to make modifications into the coarse-grained hypothesis, to make it one step closer to a more effective and more complete fine-grained hypothesis. \
                   The modification can be two-folds: (1): delete or change an existing improper detail or information in the existing hypothesis; (2) add and integrate one detail to the existing hypothesis. If you choose to add a detail, do not simply append new information to the existing hypothesis. Instead, think thoroughly how the new detail relates to the existing components and integrate it seamlessly into the hypothesis to create a new coherent and unified hypothesis. In addition if you choose to add a detail to a general information, if the corresponding general information is correct, you should try to keep the corresponding general information in the updated hypothesis and also mention the details, instead of replacing the general information with the details. In this way, it would be much easier for scientists to understand both the general infomration/structure and the details from your generated hypothesis. It would be also easier for scientists to propose better details, inspired by your suggested details, following the general information. \
                   Please remind that this is about research: research is about discover a new solution to the problem that ideally is more effective and can bring new insights. Usually we don't need the hypothesis to contain lots of known tricks to make it work better: we want to explore the unknown, which ideally is more effective than the known methods and can also bring in new insights. Therefore, a research hypothesis is usually about a small set (usually less than {num_major_details_tradition}) of major components (and lots of details on how to implement these major components), which overall composes a novel and complete solution to the research question, which potentially can bring in new insights. Hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable, as we only want to know exactly what are the key components that fundamentally make the hypothesis work. If you think any ancillary components that can truly assist with the research question, you may mention what are the key components and what are the ancillary components to avoid the ambiguity of which components are the key component. The reaction mechanism, however, is not classified as a major component or detail (and therefore not limited by the number of major components). Instead, a novel and valid reaction mechanism can be a good source of insights. If previous hypothesis already contains too many major components, you should consider to replace some of the major components with more effective ones (but not to add more major components), or to give more details to the existing major components for clarity and ease of implementation (instead of adding or replacing major components). \
                   {assist_example} \
                   The research question is: \n", "\nThe survey is: \n", "\nNow please help to make modifications into the coarse-grained hypothesis, to make it one step closer to a more effective and more complete fine-grained hypothesis. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n')"]
    elif module_name == "greedy_search_following_step":
        assert assist_info == None or assist_info == [0]
        assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis we want to reach should look like this example: \n" + hyp_example_hierarchy_5 + "\nIn this example, there are five major components, and sufficient details and experimental conditions for each major component."
        # "\nThe coarse-grained hypothesis is: \n"
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, a preliminary coarse-grained research hypothesis for the research question, and a previous (relatively more) fine-grained hypothesis derived from the coarse-grained hypothesis by a student, please help to make modifications into the fine-grained hypothesis, to make it one step closer to a more effective and more complete fine-grained hypothesis. \
                   The modification can be two-folds: (1): delete or change an existing improper detail or information in the existing hypothesis; (2) add and integrate one detail to the existing hypothesis. If you choose to add a detail, do not simply append new information to the existing hypothesis. Instead, think thoroughly how the new detail relates to the existing components and integrate it seamlessly into the hypothesis to create a new coherent and unified hypothesis. In addition if you choose to add a detail to a general information, if the corresponding general information is correct, you should try to keep the corresponding general information in the updated hypothesis and also mention the details, instead of replacing the general information with the details. In this way, it would be much easier for scientists to understand both the general infomration/structure and the details from your generated hypothesis. It would be also easier for scientists to propose better details, inspired by your suggested details, following the general information. \
                   Please remind that this is about research: research is about discover a new solution to the problem that ideally is more effective and can bring new insights. Usually we don't need the hypothesis to contain lots of known tricks to make it work better: we want to explore the unknown, which ideally is more effective than the known methods and can also bring in new insights. Therefore, a research hypothesis is usually about a small set (usually less than {num_major_details_tradition}) of major components (and lots of details on how to implement these major components), which overall composes a novel and complete solution to the research question, which potentially can bring in new insights. Hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable, as we only want to know exactly what are the key components that fundamentally make the hypothesis work. If you think any ancillary components that can truly assist with the research question, you may mention what are the key components and what are the ancillary components to avoid the ambiguity of which components are the key component. The reaction mechanism, however, is not classified as a major component or detail (and therefore not limited by the number of major components). Instead, a novel and valid reaction mechanism can be a good source of insights. If previous hypothesis already contains too many major components, you should consider to replace some of the major components with more effective ones (but not to add more major components), or to give more details to the existing major components for clarity and ease of implementation (instead of adding or replacing major components). \
                   {assist_example} \
                   The research question is: \n", "\nThe survey is: \n", "\nThe previous fine-grained hypothesis is: \n", "\nNow please help to make modifications into the previous fine-grained hypothesis, to make it one step closer to a more effective and more complete fine-grained hypothesis. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n')"]
    elif module_name == "hierarchy_greedy_search_five_hierarchy_first_step":
        assert assist_info[0] >= 0 and assist_info[0] <= 4, print("assist_info: ", assist_info)
        # assist_instruction, assist_example
        if assist_info[0] == 0:
            assist_instruction = "Mechanism of the Reaction"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (1) should look like this example: \n" + hyp_example_hierarchy_1 + "\nIn this example, the reaction mechanisms are fully described."
        elif assist_info[0] == 1:
            assist_instruction = "General Concept or General Component Needed"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (2) should look like this example: \n" + hyp_example_hierarchy_2 + "\nIn this example, the general concepts or general components needed are fully described, and each general concept is explained with why it is needed in terms of the reaction mechanism."
        elif assist_info[0] == 2:
            assist_instruction = "Specific Components for the General Concept"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (3) should look like this example: \n" + hyp_example_hierarchy_3 + "\nIn this example, the specific components for the general concepts are specified. The specific components are well integrated by explaining how they are related to the general concepts, and how they are related to the reaction mechanism."
        elif assist_info[0] == 3:
            assist_instruction = "Full Details of the Specific Components"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (4) should look like this example: \n" + hyp_example_hierarchy_4 + "\nIn this example, the full details of the specific components are specified. The full details are well integrated by explaining how they are related to the general concepts, how they are related to the reaction mechanism, and how they are related to the specific components for the general concepts."
        elif assist_info[0] == 4:
            assist_instruction = "Experimental Conditions"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (5) should look like this example: \n" + hyp_example_hierarchy_5 + "\nIn this example, the experimental conditions are fully described. The experimental conditions are well integrated by explaining how they are related to the general concepts, how they are related to the reaction mechanism, how they are related to the specific components for the general concepts, and how they are related to the full details of the specific components."
        else:
            raise NotImplementedError
        # assist_hierarchy_notice
        if assist_info[0] > 0:
            assist_hierarchy_notice = "When we search for hypothesis in an hierarchy, if we are updating/adding/removing a general/specific component, we should also update the corresponding reaction mechanism in the hypothesis (the new reaction mechanism should be more effective than the previous one judged from chemistry principles). In general we should maintain the information found in the previous hierarchies (if we are not updating them) to keep current hypothesis more complete. For example, if we are searching for experiment conditions, we should maintain the reaction mechanism, the general components, and its specified components, relation between the components and the mechanism, and the specific molecular information (if there is any, such as the CAS number) while we adding information on experimental conditions."
        else:
            assist_hierarchy_notice = ""
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, and a research hypothesis from the previous hierarchy, please help to make modifications into the hypothesis from the previous hierarchy, to make it one step closer to a more effective and more complete fine-grained hypothesis in this hierarchy. \
                   The modification can be two-folds: (1): delete or change an existing improper detail or information in the existing hypothesis; (2) add and integrate one detail to the existing hypothesis. If you choose to add a detail, do not simply append new information to the existing hypothesis. Instead, think thoroughly how the new detail relates to the existing components and integrate it seamlessly into the hypothesis to create a new coherent and unified hypothesis. In addition if you choose to add a detail to a general information, if the corresponding general information is correct, you should try to keep the corresponding general information in the updated hypothesis and also mention the details, instead of replacing the general information with the details. In this way, it would be much easier for scientists to understand both the general infomration/structure and the details from your generated hypothesis. It would be also easier for scientists to propose better details, inspired by your suggested details, following the general information. \
                   Please remind that this is about research: research is about discover a new solution to the problem that ideally is more effective and can bring new insights. Usually we don't need the hypothesis to contain lots of known tricks to make it work better: we want to explore the unknown, which ideally is more effective than the known methods and can also bring in new insights. Therefore, a research hypothesis is usually about a small set (usually less than {num_major_details_tradition}) of major components (and lots of details on how to implement these major components), which overall composes a novel and complete solution to the research question, which potentially can bring in new insights. Hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable, as we only want to know exactly what are the key components that fundamentally make the hypothesis work. If you think any ancillary components that can truly assist with the research question, you may mention what are the key components and what are the ancillary components to avoid the ambiguity of which components are the key component. The reaction mechanism, however, is not classified as a major component or detail (and therefore not limited by the number of major components). Instead, a novel and valid reaction mechanism can be a good source of insights. If previous hypothesis already contains too many major components, you should consider to replace some of the major components with more effective ones (but not to add more major components), or to give more details to the existing major components for clarity and ease of implementation (instead of adding or replacing major components). \
                   Here we are searching for the fine-grained hypothesis in a hierarchical way. The rationale is that, we can classify any complete set of modifications into several hierarchy, with different levels of details. If we do not search in a hierarchical way, we need to consider all the available details in all hierarchy levels for each search step, which (1) has a very high complexity, and (2) first search a low-level detail might largely influence the following search of a high-level detail: it might stuck in one high-level detail corresponding to the already searched low-level detail without considering the other low-level details corresponding to other high-level details, making the search process stuck in a local minumum at the beginning. \
                   Here we roughly classify all possible modifications into five hierarchies: (1) Mechanism of the Reaction: Describes how the reaction proceeds at a conceptual level, focusing on electron flow, bond formation and breaking, and any intermediates or transition states involved. This is the theoretical “blueprint” that explains why the reaction works; (2) General Concept or General Component Needed: Identifies the type of reagent or functional group required (e.g., “a strong acid,” “a Lewis base,” “an activated aromatic ring”) without committing to a specific chemical. It outlines the broader roles that are necessary for the mechanism to proceed; (3) Specific Components for the General Concept: Narrows down from the general category to a particular substance (e.g., “concentrated HCl” for a strong acid, “benzene” for an aromatic ring). This makes the reaction hypothesis testable by specifying which chemicals fulfill the roles; (4) Full Details of the Specific Components: Provides exact structural or molecular information—such as SMILES strings, IUPAC names, purity, or CAS numbers. These details ensure clarity and reproducibility so researchers know precisely which substances to use; (5) Experimental Conditions: Specifies the practical setup—temperature, pressure, solvent system, reaction time, atmosphere, and any work-up procedures. This final layer describes how to carry out the reaction in a laboratory setting. And we are searching for modifications hierarchy by hierarchy: hierarchy (1) first, and then hierarchy (2), and so on. Hypothesis from a higher hierarchy is an expansion of the hypothesis from its previous hierarchy, with additional information described above. \
                   {assist_hierarchy_notice} \
                   Here we want to search in the {assist_info[0]} hierarchy: please make modifications into the research hypothesis from the previous hierarchy in terms of {assist_instruction}, to make it one step closer to a more effective and more complete fine-grained hypothesis. Please only search for modifications inside the current hierarchy and do not search for modifications inside the next hierarchy. It is fine to delete or modify information from the previous hierarchy. \
                   {assist_example} \
                   The research question is: \n", "\nThe survey is: \n", "\nNow please help to make modifications into the hypothesis from the previous hierarchy, to make it one step closer to a more effective and more complete fine-grained hypothesis in this hierarchy. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n') "]
    elif module_name == "hierarchy_greedy_search_five_hierarchy_following_step":
        assert assist_info[0] >= 0 and assist_info[0] <= 4, print("assist_info: ", assist_info)
        # assist_instruction, assist_example
        if assist_info[0] == 0:
            assist_instruction = "Mechanism of the Reaction"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (1) should look like this example: \n" + hyp_example_hierarchy_1 + "\nIn this example, the reaction mechanisms are fully described."
        elif assist_info[0] == 1:
            assist_instruction = "General Concept or General Component Needed"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (2) should look like this example: \n" + hyp_example_hierarchy_2 + "\nIn this example, the general concepts or general components needed are fully described, and each general concept is explained with why it is needed in terms of the reaction mechanism."
        elif assist_info[0] == 2:
            assist_instruction = "Specific Components for the General Concept"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (3) should look like this example: \n" + hyp_example_hierarchy_3 + "\nIn this example, the specific components for the general concepts are specified. The specific components are well integrated by explaining how they are related to the general concepts, and how they are related to the reaction mechanism."
        elif assist_info[0] == 3:
            assist_instruction = "Full Details of the Specific Components"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (4) should look like this example: \n" + hyp_example_hierarchy_4 + "\nIn this example, the full details of the specific components are specified. The full details are well integrated by explaining how they are related to the general concepts, how they are related to the reaction mechanism, and how they are related to the specific components for the general concepts."
        elif assist_info[0] == 4:
            assist_instruction = "Experimental Conditions"
            assist_example = "Taking an organic chemistry example, the final fine-grained hypothesis of hierarchy (5) should look like this example: \n" + hyp_example_hierarchy_5 + "\nIn this example, the experimental conditions are fully described. The experimental conditions are well integrated by explaining how they are related to the general concepts, how they are related to the reaction mechanism, how they are related to the specific components for the general concepts, and how they are related to the full details of the specific components."
        else:
            raise NotImplementedError
        # assist_hierarchy_notice
        if assist_info[0] > 0:
            assist_hierarchy_notice = "When we search for hypothesis in an hierarchy, if we are updating/adding/removing a general/specific component, we should also update the corresponding reaction mechanism in the hypothesis (the new reaction mechanism should be more effective than the previous one judged from chemistry principles). In general we should maintain the information found in the previous hierarchies (if we are not updating them) to keep current hypothesis more complete. For example, if we are searching for experiment conditions, we should maintain the reaction mechanism, the general components, and its specified components, relation between the components and the mechanism, and the specific molecular information (if there is any, such as the CAS number) while we adding information on experimental conditions."
        else:
            assist_hierarchy_notice = ""
        # "\nThe research hypothesis from the previous hierarchy is: \n"
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, a research hypothesis from the previous hierarchy, and a preliminary fine-grained research hypothesis developed based on the research hypothesis from the previous hierarchy proposed by a student, please help to make modifications into the preliminary fine-grained hypothesis, to make it one step closer to a more effective and more complete fine-grained hypothesis in this hierarchy. \
                   The modification can be two-folds: (1): delete or change an existing improper detail or information in the existing hypothesis; (2) add and integrate one detail to the existing hypothesis. If you choose to add a detail, do not simply append new information to the existing hypothesis. Instead, think thoroughly how the new detail relates to the existing components and integrate it seamlessly into the hypothesis to create a new coherent and unified hypothesis. In addition if you choose to add a detail to a general information, if the corresponding general information is correct, you should try to keep the corresponding general information in the updated hypothesis and also mention the details, instead of replacing the general information with the details. In this way, it would be much easier for scientists to understand both the general infomration/structure and the details from your generated hypothesis. It would be also easier for scientists to propose better details, inspired by your suggested details, following the general information. \
                   Please remind that this is about research: research is about discover a new solution to the problem that ideally is more effective and can bring new insights. Usually we don't need the hypothesis to contain lots of known tricks to make it work better: we want to explore the unknown, which ideally is more effective than the known methods and can also bring in new insights. Therefore, a research hypothesis is usually about a small set (usually less than {num_major_details_tradition}) of major components (and lots of details on how to implement these major components), which overall composes a novel and complete solution to the research question, which potentially can bring in new insights. Hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable, as we only want to know exactly what are the key components that fundamentally make the hypothesis work. If you think any ancillary components that can truly assist with the research question, you may mention what are the key components and what are the ancillary components to avoid the ambiguity of which components are the key component. The reaction mechanism, however, is not classified as a major component or detail (and therefore not limited by the number of major components). Instead, a novel and valid reaction mechanism can be a good source of insights. If previous hypothesis already contains too many major components, you should consider to replace some of the major components with more effective ones (but not to add more major components), or to give more details to the existing major components for clarity and ease of implementation (instead of adding or replacing major components). \
                   Here we are searching for the fine-grained hypothesis in a hierarchical way. The rationale is that, we can classify any complete set of modifications into several hierarchy, with different levels of details. If we do not search in a hierarchical way, we need to consider all the available details in all hierarchy levels for each search step, which (1) has a very high complexity, and (2) first search a low-level detail might largely influence the following search of a high-level detail: it might stuck in one high-level detail corresponding to the already searched low-level detail without considering the other low-level details corresponding to other high-level details, making the search process stuck in a local minumum at the beginning. \
                   Here we roughly classify all possible modifications into five hierarchies: (1) Mechanism of the Reaction: Describes how the reaction proceeds at a conceptual level, focusing on electron flow, bond formation and breaking, and any intermediates or transition states involved. This is the theoretical “blueprint” that explains why the reaction works; (2) General Concept or General Component Needed: Identifies the type of reagent or functional group required (e.g., “a strong acid,” “a Lewis base,” “an activated aromatic ring”) without committing to a specific chemical. It outlines the broader roles that are necessary for the mechanism to proceed; (3) Specific Components for the General Concept: Narrows down from the general category to a particular substance (e.g., “concentrated HCl” for a strong acid, “benzene” for an aromatic ring). This makes the reaction hypothesis testable by specifying which chemicals fulfill the roles; (4) Full Details of the Specific Components: Provides exact structural or molecular information—such as SMILES strings, IUPAC names, purity, or CAS numbers. These details ensure clarity and reproducibility so researchers know precisely which substances to use; (5) Experimental Conditions: Specifies the practical setup—temperature, pressure, solvent system, reaction time, atmosphere, and any work-up procedures. This final layer describes how to carry out the reaction in a laboratory setting. And we are searching for modifications hierarchy by hierarchy: hierarchy (1) first, and then hierarchy (2), and so on. Hypothesis from a higher hierarchy is an expansion of the hypothesis from its previous hierarchy, with additional information described above. \
                   {assist_hierarchy_notice} \
                   Here we want to search in the {assist_info[0]} hierarchy: please make modifications into the preliminary fine-grained hypothesis in terms of {assist_instruction}, to make it one step closer to a more effective and more complete fine-grained hypothesis. Please only search for modifications inside the current hierarchy and do not search for modifications inside the next hierarchy. It is fine to delete or modify information from the previous hierarchy. \
                   {assist_example} \
                   The research question is: \n", "\nThe survey is: \n", "\nThe preliminary fine-grained hypothesis is: \n", "\nNow please help to make modifications into the preliminary fine-grained hypothesis, to make it one step closer to a more effective and more complete fine-grained hypothesis in this hierarchy. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n') "]
    elif module_name == "recombination_first_step":
        assert assist_info[0] >= 0 and assist_info[0] <= 4, print("assist_info: ", assist_info)
        if assist_info[0] > 0:
            assist_hierarchy_notice = "When we search for hypothesis in an hierarchy, if we are updating/adding/removing a general/specific component, we should also update the corresponding reaction mechanism in the hypothesis (the new reaction mechanism should be more effective than the previous one judged from chemistry principles). In general we should maintain the information found in the previous hierarchies (if we are not updating them) to keep current hypothesis more complete. For example, if we are searching for experiment conditions, we should maintain the reaction mechanism, the general components, and its specified components, relation between the components and the mechanism, and the specific molecular information (if there is any, such as the CAS number) while we adding information on experimental conditions."
        else:
            assist_hierarchy_notice = ""
        # "\nOne of the good research hypothesis candidates is: \n", 
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, several proposed research hypothesis candidates to refer to, please try your best to leverage the advantages of the hypothesis candidates and avoid their disadvantages to formulate a research hypothesis that is more effective than the existing proposed hypothesis candidates to the research question. You should rely on your own knowledge and understanding of chemistry to help this task. \
                   In research, a research hypothesis is usually about a small set (usually less than {num_major_details_tradition}) of major components (and sufficient details on how to implement these major components), which overall composes a novel and complete solution to the research question, which potentially can bring in new insights. Hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable. The focus should be on identifying the key components that are essential for the hypothesis to work, along with any supplementary components that enhance or support the primary components.  \
                   In this task, you are not required to add numerous additional details to the existing hypothesis candidates (although you are supposed to keep/remain a similar level of details in your answer). Instead, aim to formulate a more effective hypothesis that retains fewer than {num_major_details_tradition} major components by leveraging the strengths of the major components in the provided candidates and if needed, incorporating your knowledge and understanding of chemistry to compose the strengths in a reasonable and understandable way. The reaction mechanism is usually a good source of insights and is not classified as a major component or detail. Instead, it provides high-level guidance for selecting the major components and their details. If several reaction mechanisms are mentioned in the hypothesis candidates, try to select/compose one set of reaction mechanism in your answer that is more effective than the mechanisms in the existing candidates.  \
                   {assist_hierarchy_notice} \
                   The research question is: \n", "\nThe survey is: \n", "\nNow, please formulate a more effective research hypothesis by utilizing the advantages of the hypothesis candidates while addressing their disadvantages and considering the student's preliminary trial hypothesis. By 'utilizing the advantages,' the aim is not merely to aggregate appealing components, but to thoughtfully integrate strengths in a way that effectively addresses the research question. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n') "]
    elif module_name == "recombination_following_step":
        assert assist_info[0] >= 0 and assist_info[0] <= 4, print("assist_info: ", assist_info)
        if assist_info[0] > 0:
            assist_hierarchy_notice = "When we search for hypothesis in an hierarchy, if we are updating/adding/removing a general/specific component, we should also update the corresponding reaction mechanism in the hypothesis (the new reaction mechanism should be more effective than the previous one judged from chemistry principles). In general we should maintain the information found in the previous hierarchies (if we are not updating them) to keep current hypothesis more complete. For example, if we are searching for experiment conditions, we should maintain the reaction mechanism, the general components, and its specified components, relation between the components and the mechanism, and the specific molecular information (if there is any, such as the CAS number) while we adding information on experimental conditions."
        else:
            assist_hierarchy_notice = ""
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, several proposed research hypothesis candidates to refer to, please try your best to leverage the advantages of the hypothesis candidates and avoid their disadvantages to formulate a research hypothesis that is more effective than the existing proposed hypothesis candidates to the research question. You should rely on your own knowledge and understanding of chemistry to help this task. A student has made a preliminary trial to formulate a better research hypothesis, you may refer to it to improve it, or you can leave it and formulate a new one for better hypothesis. \
                   In research, a research hypothesis is usually about a small set (usually less than {num_major_details_tradition}) of major components (and sufficient details on how to implement these major components), which overall composes a novel and complete solution to the research question, which potentially can bring in new insights. Hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable. The focus should be on identifying the key components that are essential for the hypothesis to work, along with any supplementary components that enhance or support the primary components.  \
                   In this task, you are not required to add numerous additional details to the existing hypothesis candidates (although you are supposed to keep/remain a similar level of details in your answer). Instead, aim to formulate a more effective hypothesis that retains fewer than {num_major_details_tradition} major components by leveraging the strengths of the major components in the provided candidates and if needed, incorporating your knowledge and understanding of chemistry to compose the strengths in a reasonable and understandable way. The reaction mechanism is usually a good source of insights and is not classified as a major component or detail. Instead, it provides high-level guidance for selecting the major components and their details. If several reaction mechanisms are mentioned in the hypothesis candidates, try to select/compose one set of reaction mechanism in your answer that is more effective than the mechanisms in the existing candidates.  \
                   {assist_hierarchy_notice} \
                   The research question is: \n", "\nThe survey is: \n", "\nThe preliminary trial by the student is: \n", "\nNow, please formulate a more effective research hypothesis by utilizing the advantages of the hypothesis candidates while addressing their disadvantages and considering the student's preliminary trial hypothesis. By 'utilizing the advantages,' the aim is not merely to aggregate appealing components, but to thoughtfully integrate strengths in a way that effectively addresses the research question. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n') "]
    elif module_name == "validity_clarity_feedback_to_hyp":
        assert assist_info == None or (assist_info >= 0 and assist_info <= 4), print("assist_info: ", assist_info)
        if assist_info == 0:
            assist_instruction = "Here we are especially interested in feedback in terms of the mechanism of the reaction: e.g., how the reaction proceeds at a conceptual level, focusing on electron flow, bond formation and breaking, and any intermediates or transition states involved. It is the theoretical “blueprint” that explains why the reaction works. The ultimate goal is to search for the optimal set of (very clear and well explained in terms of the fundamental chemistry principles, or even well explained in the physics level) reaction mechanisms that work best to tackle the research question."
        elif assist_info == 1:
            assist_instruction = "Here we are especially interested in feedback in terms of the general concept or general component Needed: e.g., the type of reagent or functional group required (e.g., “a strong acid,” “a Lewis base,” “an activated aromatic ring”) without the need to commit to a specific chemical. It outlines the broader roles that are necessary for the mechanism to proceed. You may also think whether there are other general components that might be helpful for the hypothesis (e.g., might seemingly not a direct expansion/specification of the existing hypothesis, but is helpful), even if it might be overlooked by the reaction mechanism in the exisiting hypothesis. The ultimate goal is to search for the optimal set of general components that work best for an optimal set of reaction mechanism to tackle the research question.  \
                You can also provide feedback to the mechanism of the reaction if it is not clear or not enough effective or not enough integrated or not enough valid. Particularly, you should update the corresponding part of the reaction mechanism if you are suggesting updating/adding/removing a general or specific component (the new reaction mechanism should be more effective than the previous one judged from the fundamental chemistry principles)."
        elif assist_info == 2:
            assist_instruction = "Here we are especially interested in feedback in terms of the specific components for the general concept/component: e.g., narrows down from the general category to a particular substance (e.g., 'concentrated HCl' for 'a strong acid', 'benzene' for 'an aromatic ring', 'Barium Titanate' for 'Perovskite Oxide'), or the exact chemical equation. It makes the reaction hypothesis testable by specifying which chemicals fulfill the roles. You may also think whether there are other specific components that might be helpful for the hypothesis (e.g., might seemingly not a direct expansion/specification of the existing hypothesis, but is helpful), even if it might be overlooked by the reaction mechanism and the general components in the exisiting hypothesis. The ultimate goal is to search for the optimal set of specific components that work best for an optimal set of general components that work best for an optimal set of reaction mechanism to tackle the research question. \
                You can also provide feedback to the mechanism of the reaction or the general concept or general component needed if they are not clear or not enough effective or not enough integrated or not enough valid. Particularly, you should update the corresponding part of the reaction mechanism if you are suggesting updating/adding/removing a general or specific component (the new reaction mechanism should be more effective than the previous one judged from the fundamental chemistry principles)."
        elif assist_info == 3:
            assist_instruction = "Here we are especially interested in feedback in terms of the full details of the specific components: e.g., the exact structural or molecular information—such as SMILES strings, IUPAC names, purity, or CAS numbers, or the reaction condition of chemical equations. These details ensure clarity and reproducibility so researchers know precisely which substances to use. You may also think whether there are other reaction mechanism or component details that might be helpful for the hypothesis (e.g., might seemingly not a direct expansion/specification of the existing hypothesis, but is helpful), even if it might be overlooked by the reaction mechanism and the (general/specific) components in the exisiting hypothesis. The ultimate goal is to search for the accurate / optimal set of full details to the specific components that work best for an optimal set of reaction mechanism to tackle the research question. \
                You can also provide feedback to the mechanism of the reaction, the general concept or general component needed, or the specific components for the general concept if they are not clear or not enough effective or not enough integrated or not enough valid. Particularly, you should update the corresponding part of the reaction mechanism if you are suggesting updating/adding/removing a general or specific component (the new reaction mechanism should be more effective than the previous one judged from the fundamental chemistry principles)."
        elif assist_info == 4:
            assist_instruction = "Here we are especially interested in feedback in terms of the experimental conditions: e.g., the practical setup—temperature, pressure, solvent system, reaction time, atmosphere, equipment to use, experimental metrics and any work-up procedures. It describes how to carry out the reaction in a laboratory setting. For example, the added information could be about 'add xxx component can ensure xxx across a wide temperature range'. In this example, the specific temperature range is not specified and you should point it out. Also in this example, the use of word 'ensure' is too strong and might not be valid (more soft word is preferred). The ultimate goal is to search for the optimal and complete set of experimental conditions that work best for the components and reaction mechanisms in the hypothesis to tackle the research question. \
                You can also provide feedback to the mechanism of the reaction, the general concept or general component needed, the specific components for the general concept, or the full details of the specific components if they are not clear or not enough effective or not enough integrated or not enough valid. Particularly, you should update the corresponding part of the reaction mechanism if you are suggesting updating/adding/removing a general or specific component (the new reaction mechanism should be more effective than the previous one judged from the fundamental chemistry principles)."
        elif assist_info == None:
            assist_instruction = "In terms of validity aspect, the ultimate goal is to search for the optimal hypothesis to tackle the research question. \
                Here are some examples in terms of the clarity aspect. Example 1: the added information (or some other existing information in the hypothesis) could be about 'adding Polyaromatic Hydrocarbons (PAHs) and Benzo[a]pyrene'. However, Instead of broadly mentioning polyaromatic hydrocarbons (PAHs) as pollutants, research discussions should specify key compounds like benzo[a]pyrene (BaP, C₂₀H₁₂), a known carcinogen in cigarette smoke, grilled meats, and vehicle exhausts. Simply stating that 'PAHs are harmful' is vague—researchers should discuss how BaP forms DNA adducts through metabolic activation, leading to mutations and cancer risk. Experimental specifics, such as detecting BaP metabolites via HPLC-MS or studying its UV-induced degradation in water, make the discussion more precise and research-driven. \
                Example 2: the added information (or some other existing information in the hypothesis) could be about 'leveraging E1 elimination mechanism'. However, it is not enough to mention general concepts like the E1 elimination mechanism—you need to go deeper by specifying the exact chemicals and conditions relevant to your study. For example, stating that E1 occurs under 'high-temperature conditions' is too vague. Instead, you should specify a temperature range (e.g., 80–120°C) and discuss how different solvents or substrates influence the reaction outcome. Suppose you are studying dehydration of tert-butanol (C₄H₉OH) in sulfuric acid (H₂SO₄) to form isobutene (C₄H₈). Instead of just mentioning 'a strong acid catalyzes E1,' explicitly state how 1M H₂SO₄ at 100°C increases the rate of carbocation formation, leading to a higher yield of isobutene. By providing specific chemical names, concentrations, and temperature ranges, your discussion moves from general theoretical concepts to precise experimental conditions that define your research proposal. \
                Example 3: the added information (or some other existing information in the hypothesis) could be about 'add xxx component can ensure xxx across a wide temperature range'. In example 3, the specific temperature range is not specified and you should point it out. Also in this example, the use of word 'ensure' is too strong and might not be valid (more soft word is preferred). Particularly, you should update the corresponding part of the reaction mechanism if you are suggesting updating/adding/removing a general or specific component (the new reaction mechanism should be more effective than the previous one judged from the fundamental chemistry principles)."
        else:
            raise NotImplementedError
        # For example, the added information could be about 'add xxx component can ensure xxx across a wide temperature range'. In this example, the specific temperature range is not specified and you should point it out. Also in this example, the use of word 'ensure' is too strong and might not be valid (more soft word is preferred)
        prompts = [f"You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, a research hypothesis in the previous step, and the updated hypothesis based on the previous hypothesis, please provide feedback on the validity and clarity of the updated hypothesis. \
                   In terms of validity, the updated hypothesis has not been tested with real experiments, so please help with the scientists to identify any potential issues in the updated hypothesis that might make it ineffective or not feasible to the research question. The validity should be judged based on fundamental chemistry principles rather than the description provided in the text. The clarity aspect mainly refers to whether a hypothesis is not clear, underspecified, or any component of the hypothesis is not well integrated. Please provide feedback to the hypothesis in terms of the validity and clarity aspects. \
                   {assist_instruction}  \
                   Here are some notes you should consider when you determine the feedback on the validity and clarity of the updated hypothesis: hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable. The focus should be on identifying the key components that are essential for the hypothesis to work, along with any supplementary components that enhance or support the primary components. If you think any contents in the updated hypothesis are not very relevant and not helpful to the research question, your feedback should include how to delete the irrelevant information and possibly keep the good parts of the them (if there is any). In addition to the feedback to the unnecessary components, in general you should focus on those fundamental key components in the hypothesis that work for the research question to provide feedback in terms of how to make them more valid and effective / more clear and specified. If you think the current hypothesis is not complete, or it needs other necessary components for a better solution for the research question, you may also provide feedback or suggestions on it. Maybe think of this question when providing feedback: is this hypothesis valid / effective enough for the research question, or is the hypothesis specified enough in terms of our interested aspects? If not, then fundamentally why not? And how should we modify / refine the hypothesis to fill the gap?  \
                   Please rely on your own knowledge and understanding in chemistry to provide feedback. If you find any problems in the updated hypothesis, please also provide suggestions on how to improve the hypothesis. \
                   The research question is: \n", "\nThe survey is: \n", "\nThe previous hypothesis is: \n", "\nThe updated hypothesis is: \n", "\nThe rational of the updated hypothesis proposed by a student (which might not be reliable enough) is: \n", "\nNow please provide feedback on the validity (whether effective) and clarity (whether specified) of the updated hypothesis, and also give your suggestions on how to make it better to address your mentioned problems. Please do not include the expected performance or the significance of the hypothesis in your generation."]
    elif module_name == "update_hyp_based_on_feedback":
        prompts = ["You are assisting with scientist's research. Given their research question, a survey on the past methods for the research question, a research hypothesis in the previous step, the updated hypothesis based on the previous hypothesis, and feedback to the updated hypothesis in terms of validity (whether effective) and clarity (whether clear, specified, and integrated), please help to update the updated hypothesis based on the feedback. Please remind that hypotheses that include an excessive number of irrelevant or unnecessary major components, which do not contribute to addressing the research question, are less favorable. Instead, we want to identify the fundamental key points that can help the research hypothesis to better address the research question. \
                   If you add details to the updated hypothesis to make it more clear, please (1) make sure the details are well integrated with the existing hypothesis, i.e., how are the new details related to the reaction mechanism and the original contents in the original hypothesis, and how can it help with the original hypothesis; and (2) try to keep the corresponding general information in the previous hypothesis in the updated hypothesis while adding the specified information (if they are proper and corect), especially when the corresponding general information is about the reaction mechanism of the hypothesis. Keeping the corresponding general information that is proper and correct is beneficial, since they can help scientists to understand the structure of the hypothesis and why the details are needed in terms of its relation to the general structure. If you think the corresponding general information (e.g, reaction mechamism, and general components) has flaws and need to be updated, you may also make modifications to them." \
                   "The research question is: \n", "\nThe survey is: \n", "\nThe previous hypothesis is: \n", "\nThe updated hypothesis is: \n", "\nThe feedback to the updated hypothesis in terms of validity and clarity is: \n", "\nNow please help to refine the updated hypothesis based on the feedback. Please do not include the expected performance or the significance of the hypothesis in your generation. Please answer the question in the following response format. (response format: 'Reasoning Process: \nRevised Hypothesis: \n') "]
    else:
        raise NotImplementedError

    return prompts




# A collection of prompts for different modules
def evaluation_instruction_prompts(module_name, assist_info=None):
    num_major_details_tradition = "eight"
    if module_name == "break_finegrained_hyp_or_exp":
        assert assist_info == "hyp" or assist_info == "exp"
        if assist_info == "hyp":
            info = "research hypothesis"
        else:
            info = "experiment design"
        # 'Component: \nReasoning Process: \n'
        # The reasoning process can be why you think it can be a component, or why you think the information is describing about the component.
        prompts = [f"You are helping scientists with their research. Here we want to break a {info} into its components so to understand it more clearly. Here by 'component', we refer to a specific functional group, or a specific chemical, or a specific reaction, or other kind of specified chemistry stuff that is part of the solution (hypothesis). If there is any other information in the hypothesis describing the role or the underlying reaction mechanism of a component (a specified chemistry stuff), you should also include the information to the component (so that a complete component is a not dividable specified chemistry stuff and if available, the information describing the role or the underlying reaction mechanism of the specified chemistry stuff); else if there are no such information for a component, you can just use the specified chemistry stuff itself as the component. Please use the same line to describe the component and (if there is any) its description information (do not use '\n' to split them). Each component represents a unique part of the hypothesis and therefore usually components should barely have overlap with each other. If some parts of the hypothesis is not specified and only about a general concept, you can also count it as a component but you should mention that it is not specified. You should try to cover every component of the {info} that if we summarize the components together, a {info} with complete technical contents should be able to be recovered. If a piece of information is not about a chemistry stuff of the {info}, for example, if the piece of information is about the expected performance of the hypothesis, or the different situations the hypothesis could operate, then you should not count it as a component. The reaction mechanism itself should not be a component, but can be the information describing a component (if there is any). Please only extract one component for one time (no repetition). \
                   Please answer with the following format: 'Id of the component: \nComponent: \n'. Remember that one component is about (1) a specified chemistry stuff (or a not so specified chemistry stuff, if it is not specified), and if there is any, (2) the information describing the role or the underlying reaction mechanism of the (specified) chemistry stuff. The {info} is: \n", "\nNow please answer the question."]
    elif module_name == "break_finegrained_hyp_or_exp_refine":
        assert assist_info == "hyp" or assist_info == "exp"
        if assist_info == "hyp":
            info = "research hypothesis"
        else:
            info = "experiment design"
        prompts = [f"You are helping scientists with their research. Here we want to break a {info} into its components so to understand it more clearly. Here by 'component', we refer to a specific functional group, or a specific chemical, or a specific reaction, or other kind of specified chemistry stuff that is part of the solution (hypothesis). If there is any other information in the hypothesis describing the role or the underlying reaction mechanism of a component (a specified chemistry stuff), you should also include the information to the component (so that a complete component is a not dividable specified chemistry stuff and if available, the information describing the role or the underlying reaction mechanism of the specified chemistry stuff); else if there are no such information for a component, you can just use the specified chemistry stuff itself as the component. Please use the same line to describe the component and (if there is any) its description information (do not use '\n' to split them). Each component represents a unique part of the hypothesis and therefore usually components should barely have overlap with each other. If some parts of the hypothesis is not specified and only about a general concept, you can also count it as a component but you should mention that it is not specified. You should try to cover every component of the {info} that if we summarize the components together, a {info} with complete technical contents should be able to be recovered. If a piece of information is not about a chemistry stuff of the {info}, for example, if the piece of information is about the expected performance of the hypothesis, or the different situations the hypothesis could operate, then you should not count it as a component. The reaction mechanism itself should not be a component, but can be the information describing a component (if there is any). Please only extract one component for one time (no repetition). \
                   Now a student has tried to break the {info} into components, but the student might have missed some components, or break the {info} improperly, or have mentioned one component for more than one time. Please help the student to refine his answer. Please answer with the following format: 'Id of the component: \nComponent: \n'. Remember that one component is about (1) a specified chemistry stuff (or a not so specified chemistry stuff, if it is not specified), and if there is any, (2) the information describing the role or the underlying reaction mechanism of the (specified) chemistry stuff. The {info} is: \n", f"The student's answer to break the {info} into components is: ", "\nNow please answer the question."]
    elif module_name == "compare_components_from_gt_and_gene":
        assert len(assist_info) == 2
        assert assist_info[0] == "hyp" or assist_info[0] == "exp"
        assert assist_info[1] == True or assist_info[1] == False
        if assist_info[0] == "hyp":
            info = "research hypothesis"
        else:
            info = "experiment design"
        if assist_info[1] == True:
            oriented_info = "groundtruth"
            oriented_reverse_info = "machine generated"
        else:
            oriented_info = "machine generated"
            oriented_reverse_info = "groundtruth"
        prompts = [f"Please compare the following components from the groundtruth {info} and a machine generated {info}. We want to know how the two {info} overlap with each other. Specifically, we have decomposed each {info} into its components, and we want to know how many components in the {oriented_info} {info} are covered by the {oriented_reverse_info} {info} in which degree. \
                   By 'degree', we have four levels. Level 3: the pair of components to compare is specified and nearly completely the same; Level 2: the pair of components to compare is specified and highly related. By 'highly related', we mean that the pair of components is not completely the same, but quite close and one is very indicative towards the other: they serve as very similar functions, and the two candidates to compare partially overlap with each other; Level 1: the pair of components to compare (1) is not specified enough but is highly similar in the general concept level, or (2) is specified and is medium-level related: they might serve as similar functions, and the two candidates to compare are associated in a constructive way; Level 0: the pair of components to compare (1) is not specified enough and is not well related, or (2) is specified but not related or not well related. \
                   Please let us know which components in the {oriented_info} {info} are covered, and are covered in which level of degree. Please keep the components in the current given decomposed way when asigning 'covered degree' to each decomposed component, that is being said, if the given decomposed components are A and B, you should assign 'covered degree' to the exactly A and B components, but not create a new component C and assign a 'covered degree' to C, which might be a mixture of subsets from A and B. Each component in the {oriented_reverse_info} {info} can only be used to cover at most one component in the {oriented_info} {info} (so you should choose wisely which component in {oriented_info} {info} to match to obtain the best 'covered degree'). Please overlook those components that are not about technical contents. Please answer with the following format: 'Covered component: \nCovered level: \n'. \nThe groundtruth components are: \n", "\nThe machine generated components are: \n", f"\nNow please help us analyze how many components in the {oriented_info} {info} are covered by the {oriented_reverse_info} {info} in which degree. Please evaluate the 'covered degree' of one component for only one time."]
    elif module_name == "compare_components_from_gt_and_gene_refine":
        assert len(assist_info) == 2
        assert assist_info[0] == "hyp" or assist_info[0] == "exp"
        assert assist_info[1] == True or assist_info[1] == False
        if assist_info[0] == "hyp":
            info = "research hypothesis"
        else:
            info = "experiment design"
        if assist_info[1] == True:
            oriented_info = "groundtruth"
            oriented_reverse_info = "machine generated"
        else:
            oriented_info = "machine generated"
            oriented_reverse_info = "groundtruth"
        prompts = [f"Please compare the following components from the groundtruth {info} and a machine generated {info}. We want to know how the two {info} overlap with each other. Specifically, we have decomposed each {info} into its components, and we want to know how many components in the {oriented_info} {info} are covered by the {oriented_reverse_info} {info} in which degree. \
                   By 'degree', we have four levels. Level 3: the pair of components to compare is specified and nearly completely the same; Level 2: the pair of components to compare is specified and highly related. By 'highly related', we mean that the pair of components is not completely the same, but quite close and one is very indicative towards the other: they serve as very similar functions, and the two candidates to compare partially overlap with each other; Level 1: the pair of components to compare (1) is not specified enough but is highly similar in the general concept level, or (2) is specified and is medium-level related: they might serve as similar functions, and the two candidates to compare are associated in a constructive way; Level 0: the pair of components to compare (1) is not specified enough and is not well related, or (2) is specified but not related or not well related. \
                   Now a student has already tried to analyze the well covered components in the {oriented_info} {info} by the {oriented_reverse_info} {info}, but the student might have made mistakes, such as assigning incorrect 'covered degree' to components. Please carefully compare the components and help the student to refine and improve the comparison. Please keep the components in the current given decomposed way when asigning 'covered degree' to each decomposed component, that is being said, if the given decomposed components are A and B, you should assign 'covered degree' to the exactly A and B components, but not create a new component C and assign a 'covered degree' to C, which might be a mixture of subsets from A and B. Each component in the {oriented_reverse_info} {info} can only be used to cover at most one component in the {oriented_info} {info} (so you should choose wisely which component in {oriented_info} {info} to match to obtain the best 'covered degree'). Please overlook those components that are not about technical contents. Please answer with the following format: 'Covered component: \nCovered level: \n'. \nThe groundtruth components are: \n", "\nThe machine generated components are: \n", "\nThe student's analysis is: \n", f"\nNow please help use analyze how many components in the {oriented_info} {info} are covered by the {oriented_reverse_info} {info} in which degree. Please evaluate the 'covered degree' of one component for only one time."]
    # update pairwise_compare_prev_update's prompt with gpt-4o
    elif module_name == "pairwise_compare":
        assert len(assist_info) == 2
        assert assist_info[0] == "strict_to_hyp2" or assist_info[0] == "same_hyp1_hyp2" 
        assert assist_info[1] in [0, 1, 2, 3, 4] or assist_info[1] == None
        # strict_to_hyp2_info
        if assist_info[0] == "strict_to_hyp2":
            strict_to_hyp2_info = "We should be careful when making modifications to research hypothesis candidate 1: since once we accept the modifications (Research hypothesis candidate 2), it might be hard to revert them back." 
        else:
            strict_to_hyp2_info = ""
        # hierarchy_info
        hierarchy_info = "Here we roughly classify all possible contents in a fine-grained hypothesis into five hierarchies: (1) Mechanism of the Reaction: Describes how the reaction proceeds at a conceptual level, focusing on electron flow, bond formation and breaking, and any intermediates or transition states involved. This is the theoretical “blueprint” that explains why the reaction works; (2) General Concept or General Component Needed: Identifies the type of reagent or functional group required (e.g., “a strong acid,” “a Lewis base,” “an activated aromatic ring”) without committing to a specific chemical. It outlines the broader roles that are necessary for the mechanism to proceed; (3) Specific Components for the General Concept: Narrows down from the general category to a particular substance (e.g., “concentrated HCl” for a strong acid, “benzene” for an aromatic ring). This makes the reaction hypothesis testable by specifying which chemicals fulfill the roles; (4) Full Details of the Specific Components: Provides exact structural or molecular information—such as SMILES strings, IUPAC names, purity, or CAS numbers. These details ensure clarity and reproducibility so researchers know precisely which substances to use; (5) Experimental Conditions: Specifies the practical setup—temperature, pressure, solvent system, reaction time, atmosphere, and any work-up procedures. This final layer describes how to carry out the reaction in a laboratory setting. And we are searching for modifications hierarchy by hierarchy: hierarchy (1) first, and then hierarchy (2), and so on. Hypothesis from a higher hierarchy is an expansion of the hypothesis from its previous hierarchy, with additional information described above."
        if assist_info[1] in [0, 1, 2, 3, 4]:
            hierarchy_info = hierarchy_info + f"\nHere we focus on hierarchy ({assist_info[1]+1}). "
        elif assist_info[1] == None:
            hierarchy_info = ""
        else:
            raise NotImplementedError
        prompts = [f"You are assisting chemists in refining a research hypothesis. Given a base research hypothesis (Research hypothesis candidate 1) and an updated version (Research hypothesis candidate 2), your task is to determine whether the updated hypothesis is an improvement over the base hypothesis. The aim of this iterative process is to gradually refine an initially coarse or partially novel hypothesis into one that is effective, scientifically valid, and sufficiently detailed for real chemistry experiments. \
                   A hypothesis is only improved if it demonstrably enhances its scientific validity, conceptual clarity, or experimental feasibility based on fundamental chemistry principles. More details do not automatically make a hypothesis better. A more specific hypothesis is generally preferred only when it corrects or addresses a shortcoming in the original proposal, or significantly improves the clarity and testability of the hypothesis. If an added element does not clearly resolve a known gap or make the hypothesis more feasible for experimental validation, then the base hypothesis should be preferred. \
                   While novelty can be valuable, validity and rigorous detail take precedence in this particular task. The original or coarse-grained hypothesis already establishes some novel direction or concept. Your role here is to decide if the updated hypothesis is more practically implementable or scientifically grounded, rather than simply more novel. Claims of better performance—such as a broader temperature range or superior output—should be evaluated in light of fundamental chemistry and adequacy of design details, not just based on self-reported figures. \
                   Justifications for added details are encouraged whenever possible. However, even if a new element is not fully explained, it may still be acceptable if it addresses a concrete gap or significantly strengthens the experimental basis of the hypothesis. The main criterion is whether the modification provides unique and necessary improvements over what was already in place. If the modification adds advanced-sounding techniques or claims to cover a broader range without showing how it is fundamentally achieved and supported by chemical reasoning, it should not be considered an improvement. \
                   Experimental feasibility should not be the sole deciding factor. At this stage, scientific soundness is more important than immediate ease of implementation. That said, a hypothesis that is rigorous and includes enough detail for chemists to conduct real experiments should be favored over one that is vague or leaves essential conditions undefined. Self-reported operational ranges or performance claims are not sufficient unless backed by credible design elements—like clearly justified material choices, mechanistic rationale, or realistic testing procedures—that convincingly cover the claimed range. \
                   If the modification involves new characterization tools, materials, or system designs, it should only be considered an improvement if it corrects a known deficiency, adds clearly required experimental coverage, or resolves an unaddressed mechanism in the original hypothesis. Simply stating that a technique or material could theoretically yield more data or handle wider conditions is not enough unless it fills a real gap in the existing design or provides critical data that was missing before. \
                   A strong hypothesis should become progressively more precise and experimentally grounded with each iteration, using meaningful refinements that improve scientific logic or fill gaps. It is not improved if it includes unnecessary, redundant, or overly restrictive details that do not serve a genuine scientific purpose. Nor is it improved if it removes essential components or relies on unsubstantiated claims of broader capability. The model should not favor a hypothesis purely because it sounds novel, claims bigger numerical ranges, or appears simpler. Instead, it should prefer hypotheses that are chemically coherent, realistically testable, and address any weaknesses in the prior version. \
                   Finally, more detail is generally useful so chemists do not have to guess key conditions. However, those details must be purposeful, chemically justified, and must enhance the hypothesis’s feasibility in real experiments. If the added detail or approach does not meaningfully strengthen the hypothesis’s ability to answer the research question, it is not an improvement. \
                   {hierarchy_info} \
                   {strict_to_hyp2_info} \
                   Decide whether the updated hypothesis is better than the base hypothesis, focusing on fundamental chemistry principles, meaningful details, and whether the modification addresses a concrete gap or enhances testability. If you accept the update, explain what shortcoming it corrects or how it strengthens the hypothesis. If you reject it, explain why the base hypothesis remains more valid or complete and why the modification does not add real value or fails to align with fundamental chemistry. \
                   The research question is: \n", "\nResearch hypothesis candidate 1 is: \n", "\nResearch hypothesis candidate 2 is: \n", "\nPlease use the following response format: 'Reasoning process: \nSelection of research hypothesis candidate: \n'. When specifying the selection, use the candidate's ID."]
    elif module_name == "pairwise_compare_unify_response":
        # assist_info: [relation_hyp1_hyp2]
        #   relation_hyp1_hyp2: "strict_to_hyp2" or "same_hyp1_hyp2"
        assert len(assist_info) == 1
        assert assist_info[0] == "strict_to_hyp2" or assist_info[0] == "same_hyp1_hyp2" 
        # strict_to_hyp2_info
        if assist_info[0] == "strict_to_hyp2":
            strict_to_hyp2_info = "We should be careful when making modifications to research hypothesis candidate 1: since once we accept the modifications (Research hypothesis candidate 2), it might be hard to revert them back." 
        else:
            strict_to_hyp2_info = ""
        prompts = [f"You are assisting chemists in refining a research hypothesis. Given a base research hypothesis (Research hypothesis candidate 1) and an updated version (Research hypothesis candidate 2), your task is to determine whether the updated hypothesis is an improvement over the base hypothesis. The aim of this iterative process is to gradually refine an initially coarse or partially novel hypothesis into one that is effective, scientifically valid, and sufficiently detailed for real chemistry experiments. \
                   A hypothesis is only improved if it demonstrably enhances its scientific validity, conceptual clarity, or experimental feasibility based on fundamental chemistry principles. More details do not automatically make a hypothesis better. A more specific hypothesis is generally preferred only when it corrects or addresses a shortcoming in the original proposal, or significantly improves the clarity and testability of the hypothesis. If an added element does not clearly resolve a known gap or make the hypothesis more feasible for experimental validation, then the base hypothesis should be preferred. \
                   While novelty can be valuable, validity and rigorous detail take precedence in this particular task. The original or coarse-grained hypothesis already establishes some novel direction or concept. Your role here is to decide if the updated hypothesis is more practically implementable or scientifically grounded, rather than simply more novel. Claims of better performance—such as a broader temperature range or superior output—should be evaluated in light of fundamental chemistry and adequacy of design details, not just based on self-reported figures. \
                   Justifications for added details are encouraged whenever possible. However, even if a new element is not fully explained, it may still be acceptable if it addresses a concrete gap or significantly strengthens the experimental basis of the hypothesis. The main criterion is whether the modification provides unique and necessary improvements over what was already in place. If the modification adds advanced-sounding techniques or claims to cover a broader range without showing how it is fundamentally achieved and supported by chemical reasoning, it should not be considered an improvement. \
                   Experimental feasibility should not be the sole deciding factor. At this stage, scientific soundness is more important than immediate ease of implementation. That said, a hypothesis that is rigorous and includes enough detail for chemists to conduct real experiments should be favored over one that is vague or leaves essential conditions undefined. Self-reported operational ranges or performance claims are not sufficient unless backed by credible design elements—like clearly justified material choices, mechanistic rationale, or realistic testing procedures—that convincingly cover the claimed range. \
                   If the modification involves new characterization tools, materials, or system designs, it should only be considered an improvement if it corrects a known deficiency, adds clearly required experimental coverage, or resolves an unaddressed mechanism in the original hypothesis. Simply stating that a technique or material could theoretically yield more data or handle wider conditions is not enough unless it fills a real gap in the existing design or provides critical data that was missing before. \
                   A strong hypothesis should become progressively more precise and experimentally grounded with each iteration, using meaningful refinements that improve scientific logic or fill gaps. It is not improved if it includes unnecessary, redundant, or overly restrictive details that do not serve a genuine scientific purpose. Nor is it improved if it removes essential components or relies on unsubstantiated claims of broader capability. The model should not favor a hypothesis purely because it sounds novel, claims bigger numerical ranges, or appears simpler. Instead, it should prefer hypotheses that are chemically coherent, realistically testable, and address any weaknesses in the prior version. \
                   Finally, more detail is generally useful so chemists do not have to guess key conditions. However, those details must be purposeful, chemically justified, and must enhance the hypothesis’s feasibility in real experiments. If the added detail or approach does not meaningfully strengthen the hypothesis’s ability to answer the research question, it is not an improvement. \
                   {strict_to_hyp2_info} \
                   Now that three experts have provided their preference of the two hypotheses and their reason, please consider their advice and provide your final preference and reason. Note that it is not about voting, but about which preference is more reasonable. \
                   The research question is: \n", "\nResearch hypothesis candidate 1 is: \n", "\nResearch hypothesis candidate 2 is: \n", "\nPreference and reasons from the three experts are: \n", "\nNow, please decide whether the updated hypothesis is better than the base hypothesis, focusing on fundamental chemistry principles, meaningful details, and whether the modification addresses a concrete gap or enhances testability. If you accept the update, explain what shortcoming it corrects or how it strengthens the hypothesis. If you reject it, explain why the base hypothesis remains more valid or complete and why the modification does not add real value or fails to align with fundamental chemistry. Use the following response format: 'Reasoning process: \nSelection of research hypothesis candidate: \n'. When specifying the selection, use the candidate's ID."]
    # update pairwise_compare_prev_update's prompt with gpt-4o
    elif module_name == "pairwise_compare_between_final_hyp":
        # no need to care about assist_info
        prompts = [f"You are assisting chemists in refining a research hypothesis. Given two separate research hypotheses (Research hypothesis candidate 1 and Research hypothesis candidate 2), your task is to determine which hypothesis is more effective in addressing the research question. The goal is to evaluate each hypothesis based on its scientific validity, conceptual clarity, experimental feasibility, and how well it addresses the inherent challenges of the research question. \
                   A hypothesis is considered better if it demonstrably enhances its scientific validity, experimental feasibility, and provides a clear pathway to answering the research question based on fundamental chemistry principles. More details do not automatically make a hypothesis better, but a more specific hypothesis is generally preferred when it addresses the research question more directly and improves the experimental approach. If an added detail or component does not resolve a genuine gap or make the hypothesis more feasible, it should not be considered an improvement. \
                   While novelty is valuable, scientific rigor and valid experimental design are paramount in this task. Both hypotheses are independent and should be evaluated on their own merits. Novelty and novelty claims should be evaluated based on their scientific validity and chemically grounded justification, not just their potential for new insights. Any addition that is chemically reasonable and improves testability of the hypothesis will be considered beneficial. \
                   Justifications for added details are encouraged whenever possible. However, lack of explicit justification should not automatically disqualify an improvement if the added detail is chemically reasonable and directly improves feasibility or address a critical gap in the design. The model should evaluate each modification or addition based on whether it addresses the primary scientific challenge or improves the experimental approach, making the hypothesis more suitable for testing the research question. \
                   Experimental feasibility should not dominate the comparison. Scientific soundness and experimentally grounded principles should be prioritized. A hypothesis that is scientifically robust but more challenging to implement is preferable to one that sacrifices scientific rigor for simplicity. The ultimate goal is to ensure that the hypothesis is testable and aligned with fundamental chemistry principles, regardless of the level of complexity involved. \
                   When comparing hypotheses, focus on whether the hypothesis addresses the core aspects of the research question and whether it provides a clear, experimentally feasible solution. A strong hypothesis should cover all aspects of the question, and more detail is encouraged if it serves a specific purpose in refining the experimental setup or in resolving scientific uncertainties. The model should not favor one hypothesis over the other based on simplicity alone. If a hypothesis is vague or lacks necessary details, it should be rejected for being underdeveloped, even if it sounds conceptually appealing. \
                   Now, compare the following two hypotheses. The research question is: \n", "\nResearch hypothesis candidate 1 is: \n", "\nResearch hypothesis candidate 2 is: \n", "\nPlease use the following response format: 'Reasoning process: \nSelection of research hypothesis candidate: \n'. When specifying the selection, use the candidate's ID."]
    # update pairwise_compare_prev_update's prompt with gpt-4o
    elif module_name == "pairwise_compare_between_final_hyp_unify_response":
        # no need to care about assist_info
        prompts = [f"You are assisting chemists in refining a research hypothesis. Given two separate research hypotheses (Research hypothesis candidate 1 and Research hypothesis candidate 2), your task is to determine which hypothesis is more effective in addressing the research question. The goal is to evaluate each hypothesis based on its scientific validity, conceptual clarity, experimental feasibility, and how well it addresses the inherent challenges of the research question. \
                   A hypothesis is considered better if it demonstrably enhances its scientific validity, experimental feasibility, and provides a clear pathway to answering the research question based on fundamental chemistry principles. More details do not automatically make a hypothesis better, but a more specific hypothesis is generally preferred when it addresses the research question more directly and improves the experimental approach. If an added detail or component does not resolve a genuine gap or make the hypothesis more feasible, it should not be considered an improvement. \
                   While novelty is valuable, scientific rigor and valid experimental design are paramount in this task. Both hypotheses are independent and should be evaluated on their own merits. Novelty and novelty claims should be evaluated based on their scientific validity and chemically grounded justification, not just their potential for new insights. Any addition that is chemically reasonable and improves testability of the hypothesis will be considered beneficial. \
                   Justifications for added details are encouraged whenever possible. However, lack of explicit justification should not automatically disqualify an improvement if the added detail is chemically reasonable and directly improves feasibility or address a critical gap in the design. The model should evaluate each modification or addition based on whether it addresses the primary scientific challenge or improves the experimental approach, making the hypothesis more suitable for testing the research question. \
                   Experimental feasibility should not dominate the comparison. Scientific soundness and experimentally grounded principles should be prioritized. A hypothesis that is scientifically robust but more challenging to implement is preferable to one that sacrifices scientific rigor for simplicity. The ultimate goal is to ensure that the hypothesis is testable and aligned with fundamental chemistry principles, regardless of the level of complexity involved. \
                   When comparing hypotheses, focus on whether the hypothesis addresses the core aspects of the research question and whether it provides a clear, experimentally feasible solution. A strong hypothesis should cover all aspects of the question, and more detail is encouraged if it serves a specific purpose in refining the experimental setup or in resolving scientific uncertainties. The model should not favor one hypothesis over the other based on simplicity alone. If a hypothesis is vague or lacks necessary details, it should be rejected for being underdeveloped, even if it sounds conceptually appealing. \
                   Now that three experts have provided their preference of the two hypotheses and their reason, please consider their advice and provide your final preference and reason. Note that it is not about voting, but about which preference is more reasonable. \
                   The research question is: \n", "\nResearch hypothesis candidate 1 is: \n", "\nResearch hypothesis candidate 2 is: \n", "\nPreference and reasons from the three experts are: \n", "\nNow, please decide whether the updated hypothesis is better than the base hypothesis, focusing on fundamental chemistry principles, meaningful details, and whether the modification addresses a concrete gap or enhances testability. If you accept the update, explain what shortcoming it corrects or how it strengthens the hypothesis. If you reject it, explain why the base hypothesis remains more valid or complete and why the modification does not add real value or fails to align with fundamental chemistry. Use the following response format: 'Reasoning process: \nSelection of research hypothesis candidate: \n'. When specifying the selection, use the candidate's ID."]
    else:
        raise NotImplementedError

    return prompts



def preprocessing_instruction_prompts(module_name, assist_info=None):
    if module_name == "preprocess_cg_hyp_to_research_direction":
        prompts = ["We want to replicate the interaction between professor and his phd student's interaction. Specifically, given a research question, the professor will give the student a general research direction, and then the student work on that direction to propose a specific research hypothesis.  \
                   Now we already know the research question, and the research hypothesis proposed by the student, and we want to infer what the research direction the professor has given. You will be also given the major functional components of the research hypothesis.  \
                   The professor's research direction in general should include the one-level more general chemical class of each of the major functional components (but not two-level more). For example, if one component is Barium Titanate (BaTiO₃), then the one-level more general level can be Perovskite Oxide, but not two-level more general level such as Ceramic. For another example, if one component is about Sulfate Ion, the one-level more general level can be Hofmeister series. One exception is that if a major component is already not specified enough (e.g., Perovskite Oxide, or Hofmeister series) and it is not directly mention in the research hypothesis, you should try to rephrase it with very similar concept (if there is any) but no need to make it one level more general, else if it is very hard to find a similar enough concept, you can keep it as it is.  For each major component however, there could be several one-level more general chemical class. For example, the Sulfate Ion can belong to both Hofmeister series and Oxyanion. But it is important that you should assign the one-level more general class that is more directly relevant to the research question and the research hypothesis.  However, if there is any component in the research hypothesis that is not in the summarized major components, you should keep it as it is in the research direction. For example, if there is Guanidine sulfate mentioned in the research hypothesis, and Hofmeister series is included in the major components (but Guanidine ion is not included in the major components), it is clear that Sulfate ions is related to Hofmeister series, but the Guanidine ion is not included in the major components, so in this case you should keep the Guanidine ion in the research direction given by the professor. \
                   The professor's research direction should also not specifiy any reaction mechanism, i.e., if there is any reaction mechanism in the research hypothesis, you should delete them but you should add enough descriptions that are indicative to the deleted reaction mechanism.  \
                   Although the research direction can only contain the one-level more general chemical class of each of the major components, and if there is any reaction mechanism involved, you should try not to include any exact same word of the major component or the reaction mechanism in the research direction, however the research direction should be enough inspiring to the students to come out of the research hypothesis: to do it you may consider to add some more descriptions in addition to give the one-level more general chemicals, or some other ways that you think is proper. You can mention the exact word if it is the case as we have discussed that the major component is already not specified enough (e.g., Hofmeister series, Perovskite Oxide). The research direction you are formulating should include information related to all of the listed major components (e.g., one-level more general chemical, or a similar/same concept if a major components if already not specified enough). \
                   Now let's have a try. The research question is: \n", "\nThe research hypothesis proposed by the student is: \n", "\nThe major components of the research hypothesis are: \n", "\nNow, please try to guess the research direction the professor give the phd student in the first place. Please answer with the following response format: 'Reasoning process: \nResearch direction: \n'."]
    elif module_name == "preprocess_cg_hyp_to_research_direction_refine":
        prompts = ["We want to replicate the interaction between professor and his phd student's interaction. Specifically, given a research question, the professor will give the student a general research direction, and then the student work on that direction to propose a specific research hypothesis.  \
                   Now we already know the research question, and the research hypothesis proposed by the student, and we want to infer what the research direction the professor has given. You will be also given the major functional components of the research hypothesis.  \
                   The professor's research direction in general should include the one-level more general chemical class of each of the major functional components (but not two-level more). For example, if one component is Barium Titanate (BaTiO₃), then the one-level more general level can be Perovskite Oxide, but not two-level more general level such as Ceramic. For another example, if one component is about Sulfate Ion, the one-level more general level can be Hofmeister series. One exception is that if a major component is already not specified enough (e.g., Perovskite Oxide, or Hofmeister series) and it is not directly mention in the research hypothesis, you should try to rephrase it with very similar concept (if there is any) but no need to make it one level more general, else if it is very hard to find a similar enough concept, you can keep it as it is.  For each major component however, there could be several one-level more general chemical class. For example, the Sulfate Ion can belong to both Hofmeister series and Oxyanion. But it is important that you should assign the one-level more general class that is more directly relevant to the research question and the research hypothesis.  However, if there is any component in the research hypothesis that is not in the summarized major components, you should keep it as it is in the research direction. For example, if there is Guanidine sulfate mentioned in the research hypothesis, and Hofmeister series is included in the major components (but Guanidine ion is not included in the major components), it is clear that Sulfate ions is related to Hofmeister series, but the Guanidine ion is not included in the major components, so in this case you should keep the Guanidine ion in the research direction given by the professor. \
                   The professor's research direction should also not specifiy any reaction mechanism, i.e., if there is any reaction mechanism in the research hypothesis, you should delete them but you should add enough descriptions that are indicative to the deleted reaction mechanism.  \
                   Although the research direction can only contain the one-level more general chemical class of each of the major components, and if there is any reaction mechanism involved, you should try not to include any exact same word of the major component or the reaction mechanism in the research direction, however the research direction should be enough inspiring to the students to come out of the research hypothesis: to do it you may consider to add some more descriptions in addition to give the one-level more general chemicals, or some other ways that you think is proper. You can mention the exact word if it is the case as we have discussed that the major component is already not specified enough (e.g., Hofmeister series, Perovskite Oxide). The research direction you are formulating should include information related to all of the listed major components (e.g., one-level more general chemical, or a similar/same concept if a major components if already not specified enough). \
                   Here is a trial to recover the professor's research direction. It might be not perfect, or violate some of the guildlines. Please help to refine the research direction. \
                   Now let's have a try. The research question is: \n", "\nThe research hypothesis proposed by the student is: \n", "\nThe major components of the research hypothesis are: \n", "\nThe trial to recover the professor's research direction is: \n", "\nNow, please try to guess the research direction the professor give the phd student in the first place. Please answer with the following response format: 'Reasoning process: \nResearch direction: \n'."]
    else:
        raise NotImplementedError
    return prompts

